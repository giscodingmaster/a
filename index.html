<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø¤ÙŠØ© 2026 - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
    
    <!-- External Dependencies (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #000015;
            color: white;
            transition: background-color 0.5s ease, color 0.5s ease;
            overflow-x: hidden;
        }
        .light-mode {
            background-color: #f0f4f8;
            color: #1a202c;
        }
        @keyframes text-flicker {
            0% { opacity: 0.8; text-shadow: 0 0 10px #a8edea; }
            50% { opacity: 1; text-shadow: 0 0 20px #fed6e3; }
            100% { opacity: 0.9; text-shadow: 0 0 15px #ffffff; }
        }
        .flicker {
            animation: text-flicker 4s infinite alternate;
        }
        .floating {
            animation: floating 4s ease-in-out infinite;
        }
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }
        .pulse {
            animation: pulse-glow 2.5s infinite;
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 10px rgba(0, 191, 255, 0.3), inset 0 0 15px rgba(0, 191, 255, 0.2); }
            50% { box-shadow: 0 0 20px rgba(137, 207, 240, 0.6), inset 0 0 25px rgba(137, 207, 240, 0.4); }
            100% { box-shadow: 0 0 10px rgba(0, 191, 255, 0.3), inset 0 0 15px rgba(0, 191, 255, 0.2); }
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .animate-in { animation: animateIn 0.3s ease-out forwards; }
        @keyframes animateIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyBw0DLQnIfL7g0zd-cSKmQJTbERxrXxnfA",
          authDomain: "dprt-archticture.firebaseapp.com",
          databaseURL: "https://dprt-archticture-default-rtdb.firebaseio.com",
          projectId: "dprt-archticture",
          storageBucket: "dprt-archticture.firebasestorage.app",
          messagingSenderId: "736962866624",
          appId: "1:736962866624:web:ea63c054a655d03accac25",
          measurementId: "G-99JVTM14X5"
        };

        // Initialize Firebase
        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase Init Error: Check your configuration at the top of the script.", e);
        }

        // Expose to window for React
        window.firebaseDb = db;
        window.firebaseSet = set;
        window.firebaseRef = ref;
        window.firebaseOnValue = onValue;
        
        window.firebaseAuth = auth;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- DATA STRUCTURE ---
        const INITIAL_ORG_DATA = {
          ceo: {
            id: 'ceo',
            role: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…',
            name: 'Ø£/ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¹ÙˆØ§Ù…ÙŠ',
            description: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…: Ø£/ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø¹ÙˆØ§Ù…ÙŠ - Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©',
            colorClass: 'bg-gradient-to-br from-[#483D8B] to-[#00008B]'
          },
          expert: {
            id: 'expert',
            role: 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø®Ø¨ÙŠØ±',
            name: 'Ù…/ Ù…Ø­Ù…Ø¯ Ø¹Ø·ÙŠØ©',
            description: 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ø®Ø¨ÙŠØ±: Ù…/ Ù…Ø­Ù…Ø¯ Ø¹Ø·ÙŠØ© - Ù…Ø³Ø¤ÙˆÙ„ Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù… Ø³ÙŠØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†',
            colorClass: 'bg-gradient-to-br from-[#00CED1] to-[#20B2AA]'
          },
          assistant: {
            id: 'assistant',
            role: 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ù…Ø³Ø§Ø¹Ø¯',
            name: 'Ù…/ Ø³Ø§Ø±Ø© Ù…Ø­Ù…Ø¯ ØµØ§Ù„Ø­',
            description: 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… Ù…Ø³Ø§Ø¹Ø¯: Ù…/ Ø³Ø§Ø±Ø© Ù…Ø­Ù…Ø¯ ØµØ§Ù„Ø­ - Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±',
            colorClass: 'bg-gradient-to-br from-[#8A2BE2] to-[#4B0082]'
          },
          technical: {
            id: 'technical',
            role: 'Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„ÙÙ†ÙŠ',
            name: 'Ù…/ Ù…Ø­Ù…Ø¯ ÙƒÙ…Ø§Ù„',
            description: 'Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ ÙˆØ§Ù„Ù…ÙƒØªØ¨ Ø§Ù„ÙÙ†ÙŠ: Ù…/ Ù…Ø­Ù…Ø¯ ÙƒÙ…Ø§Ù„',
            colorClass: 'bg-gradient-to-br from-[#4682B4] to-[#1E90FF]'
          },
          subManagers: [
            {
              id: 'sami',
              role: 'Ù…Ø¯ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯',
              name: 'Ø£/ Ø³Ø§Ù…ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø¨ÙˆØ¯',
              description: 'Ù…Ø¯ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯: Ø£/ Ø³Ø§Ù…ÙŠ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø¨ÙˆØ¯ - ÙŠØ´Ø±Ù Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©',
              colorClass: 'bg-gradient-to-br from-[#3b82f6] to-[#2563eb]',
              regions: [
                { 
                  id: 'menofia', 
                  role: 'Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©', 
                  name: 'Ø£/ Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„', 
                  description: 'Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©: Ø£/ Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„', 
                  colorClass: 'bg-gradient-to-br from-[#5F9EA0] to-[#008B8B]',
                  stats: { total: 120, egyptGas: 80, institution: 40, pcCount: 55 },
                  architecture: {
                    supervisor: 'Ø£/ Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„',
                    dataEntry: { role: 'Ù…Ø´Ø±Ù Ø¥Ø¯Ø®Ø§Ù„', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    recordingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ ØªØ³Ø¬ÙŠÙ„ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    surveyingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ Ù…Ø³Ø§Ø­ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' }
                  }
                }
              ]
            },
            {
              id: 'hussein',
              role: 'Ù…Ø¯ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯',
              name: 'Ø£/ Ø­Ø³ÙŠÙ† Ø³Ø¹ÙŠØ¯',
              description: 'Ù…Ø¯ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯: Ø£/ Ø­Ø³ÙŠÙ† Ø³Ø¹ÙŠØ¯ - ÙŠØ´Ø±Ù Ø¹Ù„Ù‰ Ù…Ù†Ø§Ø·Ù‚ Ø´Ø±Ù‚ Ø§Ù„Ù†ÙŠÙ„ØŒ Ø§Ù„ØºØ±Ø¨ÙŠØ©ØŒ ÙˆØ§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©',
              colorClass: 'bg-gradient-to-br from-[#3b82f6] to-[#2563eb]',
              regions: [
                { 
                  id: 'eastnile', 
                  role: 'Ù…Ù†Ø·Ù‚Ø© Ø´Ø±Ù‚ Ø§Ù„Ù†ÙŠÙ„', 
                  name: 'Ø£/ ÙˆÙ„ÙŠØ¯ Ù…Ø­ÙŠ', 
                  description: 'Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø© Ø´Ø±Ù‚ Ø§Ù„Ù†ÙŠÙ„: Ø£/ ÙˆÙ„ÙŠØ¯ Ù…Ø­ÙŠ', 
                  colorClass: 'bg-gradient-to-br from-[#5F9EA0] to-[#008B8B]',
                  stats: { total: 200, egyptGas: 130, institution: 70, pcCount: 90 },
                  architecture: {
                    supervisor: 'Ø£/ ÙˆÙ„ÙŠØ¯ Ù…Ø­ÙŠ',
                    dataEntry: { role: 'Ù…Ø´Ø±Ù Ø¥Ø¯Ø®Ø§Ù„', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    recordingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ ØªØ³Ø¬ÙŠÙ„ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    surveyingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ Ù…Ø³Ø§Ø­ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' }
                  }
                },
                { 
                  id: 'gharbia', 
                  role: 'Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØºØ±Ø¨ÙŠØ©', 
                  name: 'Ø£/ Ù…Ø¬Ø¯ÙŠ ØµØ§Ù„Ø­', 
                  description: 'Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØºØ±Ø¨ÙŠØ©: Ø£/ Ù…Ø¬Ø¯ÙŠ ØµØ§Ù„Ø­', 
                  colorClass: 'bg-gradient-to-br from-[#5F9EA0] to-[#008B8B]',
                  stats: { total: 150, egyptGas: 100, institution: 50, pcCount: 65 },
                  architecture: {
                    supervisor: 'Ø£/ Ù…Ø¬Ø¯ÙŠ ØµØ§Ù„Ø­',
                    dataEntry: { role: 'Ù…Ø´Ø±Ù Ø¥Ø¯Ø®Ø§Ù„', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    recordingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ ØªØ³Ø¬ÙŠÙ„ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    surveyingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ Ù…Ø³Ø§Ø­ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' }
                  }
                },
                { 
                  id: 'alex', 
                  role: 'Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©', 
                  name: 'Ø£/ Ø£Ø³Ø§Ù…Ø© Ø¬Ù„Ø§Ù„', 
                  description: 'Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©: Ø£/ Ø£Ø³Ø§Ù…Ø© Ø¬Ù„Ø§Ù„', 
                  colorClass: 'bg-gradient-to-br from-[#5F9EA0] to-[#008B8B]',
                  stats: { total: 250, egyptGas: 180, institution: 70, pcCount: 110 },
                  architecture: {
                    supervisor: 'Ø£/ Ø£Ø³Ø§Ù…Ø© Ø¬Ù„Ø§Ù„',
                    dataEntry: { role: 'Ù…Ø´Ø±Ù Ø¥Ø¯Ø®Ø§Ù„', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    recordingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ ØªØ³Ø¬ÙŠÙ„ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    surveyingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ Ù…Ø³Ø§Ø­ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' }
                  }
                }
              ]
            },
            {
              id: 'safwat',
              role: 'Ù…Ø¯ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯',
              name: 'Ø£/ ØµÙÙˆØª Ø¹ÙˆÙŠØ³',
              description: 'Ù…Ø¯ÙŠØ± Ù…Ø³Ø§Ø¹Ø¯: Ø£/ ØµÙÙˆØª Ø¹ÙˆÙŠØ³ - ÙŠØ´Ø±Ù Ø¹Ù„Ù‰ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ÙˆØ±Ø§Ù‚ØŒ Ø§Ù„ØµØ¹ÙŠØ¯ØŒ ÙˆØ§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©',
              colorClass: 'bg-gradient-to-br from-[#3b82f6] to-[#2563eb]',
              regions: [
                { 
                  id: 'warraq', 
                  role: 'Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØ±Ø§Ù‚', 
                  name: 'Ø£/ Ø¬Ù…Ø§Ù„ Ø¹Ø¨Ø¯Ø§Ù„Ø¸Ø§Ù‡Ø±', 
                  description: 'Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØ±Ø§Ù‚: Ø£/ Ø¬Ù…Ø§Ù„ Ø¹Ø¨Ø¯Ø§Ù„Ø¸Ø§Ù‡Ø±', 
                  colorClass: 'bg-gradient-to-br from-[#5F9EA0] to-[#008B8B]',
                  stats: { total: 110, egyptGas: 70, institution: 40, pcCount: 45 },
                  architecture: {
                    supervisor: 'Ø£/ Ø¬Ù…Ø§Ù„ Ø¹Ø¨Ø¯Ø§Ù„Ø¸Ø§Ù‡Ø±',
                    dataEntry: { role: 'Ù…Ø´Ø±Ù Ø¥Ø¯Ø®Ø§Ù„', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    recordingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ ØªØ³Ø¬ÙŠÙ„ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    surveyingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ Ù…Ø³Ø§Ø­ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' }
                  }
                },
                { 
                  id: 'saeed', 
                  role: 'Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØµØ¹ÙŠØ¯', 
                  name: 'Ø£/ Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù…', 
                  description: 'Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØµØ¹ÙŠØ¯: Ø£/ Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù…', 
                  colorClass: 'bg-gradient-to-br from-[#5F9EA0] to-[#008B8B]',
                  stats: { total: 300, egyptGas: 200, institution: 100, pcCount: 130 },
                  architecture: {
                    supervisor: 'Ø£/ Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù…',
                    dataEntry: { role: 'Ù…Ø´Ø±Ù Ø¥Ø¯Ø®Ø§Ù„', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    recordingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ ØªØ³Ø¬ÙŠÙ„ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    surveyingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ Ù…Ø³Ø§Ø­ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' }
                  }
                },
                { 
                  id: 'dakahlia', 
                  role: 'Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©', 
                  name: 'Ø£/ Ù…Ø§Ø¬Ø¯ Ù…ÙˆØ³Ù‰', 
                  description: 'Ù…Ø¯ÙŠØ± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©: Ø£/ Ù…Ø§Ø¬Ø¯ Ù…ÙˆØ³Ù‰', 
                  colorClass: 'bg-gradient-to-br from-[#5F9EA0] to-[#008B8B]',
                  stats: { total: 180, egyptGas: 120, institution: 60, pcCount: 80 },
                  architecture: {
                    supervisor: 'Ù…/ Ù…Ø§Ø¬Ø¯ Ù…ÙˆØ³Ù‰',
                    dataEntry: { role: 'Ù…Ø´Ø±Ù Ø¥Ø¯Ø®Ø§Ù„', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    recordingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ ØªØ³Ø¬ÙŠÙ„ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' },
                    surveyingUpload: { role: 'Ù…Ø´Ø±Ù Ø±ÙØ¹ Ù…Ø³Ø§Ø­ÙŠ', name: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†' }
                  }
                }
              ]
            }
          ]
        };

        // --- COMPONENTS ---

        const OrgNode = ({ manager, onClick, className = "", pulse = false, floating = false, compact = false }) => {
          return (
            <div 
              onClick={() => onClick && onClick(manager)}
              className={`
                org-node group cursor-pointer rounded-2xl text-center shadow-lg border border-white/20 hover:scale-105 hover:border-white/50 transition-all duration-300 relative
                ${manager.colorClass} ${pulse ? 'pulse' : ''} ${floating ? 'floating' : ''} ${className}
                ${compact ? 'p-2 min-w-[120px]' : 'p-4 min-w-[180px]'} flex flex-col items-center justify-center
              `}
              style={{
                boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
              }}
            >
              <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <svg className="w-4 h-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>  
              </div>
              <div className={`${compact ? 'text-[10px]' : 'text-sm'} font-bold text-white/80`}>{manager.role}</div>
              <div className={`${compact ? 'text-sm' : 'text-lg'} font-bold text-white mt-1 leading-tight`}>{manager.name}</div>
            </div>
          );
        };

        const EditIcon = ({ isReadOnly }) => {
          if (isReadOnly) return null;
          return (
            <svg className="w-4 h-4 opacity-40 group-focus-within:opacity-100 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
          );
        };

        const LoginModal = ({ onClose, onLogin, theme }) => {
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);
            const isDark = theme === 'dark';

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError("");
                try {
                    await onLogin(email, password);
                    onClose();
                } catch (err) {
                    console.error(err);
                    setError("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onClose} />
                    <div className={`relative w-full max-w-md p-8 rounded-3xl shadow-2xl animate-in ${isDark ? 'bg-slate-900 border border-white/10' : 'bg-white'}`}>
                        <h2 className="text-2xl font-bold mb-6 text-center">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold opacity-70 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                <input 
                                    type="email" 
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className={`w-full p-3 rounded-xl border bg-transparent ${isDark ? 'border-white/20 focus:border-cyan-500' : 'border-slate-300 focus:border-blue-500'}`}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold opacity-70 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input 
                                    type="password" 
                                    required
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className={`w-full p-3 rounded-xl border bg-transparent ${isDark ? 'border-white/20 focus:border-cyan-500' : 'border-slate-300 focus:border-blue-500'}`}
                                />
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <div className="pt-4 flex gap-3">
                                <button type="submit" disabled={loading} className="flex-1 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-xl font-bold hover:shadow-lg disabled:opacity-50">
                                    {loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...' : 'Ø¯Ø®ÙˆÙ„'}
                                </button>
                                <button type="button" onClick={onClose} className="px-6 py-3 rounded-xl border border-white/10 hover:bg-white/5">Ø¥Ù„ØºØ§Ø¡</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const GeneralEditModal = ({ manager, onClose, onSave, theme, isReadOnly }) => {
          const [data, setData] = useState({ name: '', role: '', description: '' });

          useEffect(() => {
            if (manager) setData({ name: manager.name, role: manager.role, description: manager.description || '' });
          }, [manager]);

          if (!manager) return null;
          const isDark = theme === 'dark';

          return (
             <div className="fixed inset-0 z-[110] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-black/80 backdrop-blur-md" onClick={onClose} />
              <div className={`relative w-full max-w-lg overflow-hidden border rounded-3xl shadow-2xl p-8 animate-in ${isDark ? 'bg-slate-900/95 text-white border-white/10' : 'bg-white/95 text-slate-900 border-slate-200'}`}>
                <h3 className="text-2xl font-bold mb-6 text-center">{isReadOnly ? 'ØªÙØ§ØµÙŠÙ„' : 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'}</h3>
                
                <div className="space-y-4">
                  <div>
                    <label className="text-xs font-bold opacity-60">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                    <input 
                        type="text" 
                        value={data.role} 
                        readOnly={isReadOnly}
                        onChange={e => setData({...data, role: e.target.value})} 
                        className={`w-full p-3 rounded-xl border bg-transparent mt-1 ${isReadOnly ? 'border-transparent' : (isDark ? 'border-white/20 focus:border-cyan-400' : 'border-slate-300 focus:border-cyan-500')}`} 
                    />
                  </div>
                  <div>
                    <label className="text-xs font-bold opacity-60">Ø§Ù„Ø§Ø³Ù…</label>
                    <input 
                        type="text" 
                        value={data.name} 
                        readOnly={isReadOnly}
                        onChange={e => setData({...data, name: e.target.value})} 
                        className={`w-full p-3 rounded-xl border bg-transparent mt-1 ${isReadOnly ? 'border-transparent font-bold text-lg' : (isDark ? 'border-white/20 focus:border-cyan-400' : 'border-slate-300 focus:border-cyan-500')}`} 
                    />
                  </div>
                  <div>
                    <label className="text-xs font-bold opacity-60">Ø§Ù„ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea 
                        value={data.description} 
                        readOnly={isReadOnly}
                        onChange={e => setData({...data, description: e.target.value})} 
                        rows="3" 
                        className={`w-full p-3 rounded-xl border bg-transparent mt-1 ${isReadOnly ? 'border-transparent' : (isDark ? 'border-white/20 focus:border-cyan-400' : 'border-slate-300 focus:border-cyan-500')}`}
                    ></textarea>
                  </div>
                </div>

                <div className="flex gap-4 mt-8">
                  {!isReadOnly && (
                      <button onClick={() => onSave(manager.id, data)} className="flex-1 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 rounded-xl font-bold hover:shadow-lg transition-all">Ø­ÙØ¸</button>
                  )}
                  <button onClick={onClose} className={`px-6 py-3 rounded-xl border hover:bg-white/5 ${isReadOnly ? 'w-full' : ''} ${isDark ? 'border-white/10' : 'border-slate-300'}`}>Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
              </div>
            </div>
          );
        };

        const ArchitectureModal = ({ manager, onClose, onSave, theme, isReadOnly }) => {
          const [localArch, setLocalArch] = useState(null);

          useEffect(() => {
            if (manager?.architecture) {
              setLocalArch({ ...manager.architecture });
            }
          }, [manager]);

          if (!manager || !localArch) return null;

          const handlePersonnelChange = (field, value) => {
            setLocalArch(prev => prev ? ({
              ...prev,
              [field]: { ...prev[field], name: value }
            }) : null);
          };

           const handleSupervisorChange = (value) => {
             setLocalArch(prev => prev ? ({ ...prev, supervisor: value }) : null);
           };

          const handleSave = () => {
            if (manager.id && localArch) {
              onSave(manager.id, localArch);
              onClose();
            }
          };

          const isDark = theme === 'dark';

          return (
            <div className="fixed inset-0 z-[110] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-black/90 backdrop-blur-xl" onClick={onClose} />
              <div className={`relative w-full max-w-4xl overflow-hidden border rounded-[3rem] shadow-2xl p-0 animate-in ${isDark ? 'bg-slate-900/95 text-white border-white/10' : 'bg-white/95 text-slate-900 border-slate-200'}`}>
                <div className="absolute top-0 left-0 w-full h-40 bg-gradient-to-br from-indigo-600/20 via-purple-600/20 to-cyan-600/20 opacity-50 blur-3xl pointer-events-none" />
                <div className="p-8 md:p-12 relative z-10 max-h-[90vh] overflow-y-auto">
                  <button onClick={onClose} className="absolute top-8 left-8 p-2 hover:bg-white/10 rounded-full transition-colors">
                    <svg className="w-8 h-8 opacity-50 hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                  <header className="text-center mb-10">
                     <div className="inline-block px-4 py-1 rounded-full bg-cyan-500/10 text-cyan-400 text-xs font-bold mb-4 tracking-widest uppercase border border-cyan-500/20">Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù‚ÙˆÙ‰ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</div>
                     <h2 className="text-4xl font-black bg-gradient-to-r from-white via-cyan-200 to-blue-400 bg-clip-text text-transparent">{manager.role}</h2>
                  </header>
                  <div className="flex flex-col items-center gap-12">
                    <div className="relative">
                      <div className="px-10 py-6 bg-gradient-to-br from-indigo-600 to-blue-800 rounded-3xl shadow-2xl border border-white/20 text-center min-w-[280px] group">
                        <div className="text-xs font-bold text-white/60 mb-1">Ù…Ø´Ø±Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</div>
                        <input 
                           type="text" 
                           value={localArch.supervisor} 
                           readOnly={isReadOnly}
                           onChange={(e) => handleSupervisorChange(e.target.value)}
                           className={`bg-transparent text-2xl font-black text-white text-center w-full focus:outline-none border-b ${isReadOnly ? 'border-transparent' : 'border-transparent focus:border-white/50'}`}
                        />
                        <EditIcon isReadOnly={isReadOnly} />
                      </div>
                      <div className="absolute left-1/2 -translate-x-1/2 top-full w-1 h-12 bg-gradient-to-b from-blue-500 to-cyan-500" />
                    </div>
                    <div className="relative w-full max-w-3xl">
                       <div className="absolute top-[-1px] left-1/2 -translate-x-1/2 w-full h-[2px] bg-cyan-500" />
                       <div className="grid grid-cols-1 md:grid-cols-3 gap-8 pt-12">
                          {[
                            { key: 'dataEntry', color: 'from-emerald-600 to-teal-800' },
                            { key: 'recordingUpload', color: 'from-amber-600 to-orange-800' },
                            { key: 'surveyingUpload', color: 'from-cyan-600 to-blue-800' }
                          ].map((node) => (
                            <div key={node.key} className="relative flex flex-col items-center">
                               <div className="absolute top-[-48px] w-1 h-12 bg-cyan-500" />
                               <div className={`group w-full p-6 rounded-3xl bg-gradient-to-br ${node.color} shadow-xl border border-white/10 ${!isReadOnly ? 'hover:scale-105 transition-all duration-300' : ''}`}>
                                  <div className="text-[10px] font-bold text-white/50 mb-2 tracking-tighter uppercase">{localArch[node.key].role}</div>
                                  <div className="flex items-center gap-2">
                                     <input 
                                       type="text"
                                       value={localArch[node.key].name}
                                       readOnly={isReadOnly}
                                       onChange={(e) => handlePersonnelChange(node.key, e.target.value)}
                                       className={`bg-transparent text-lg font-bold text-white focus:outline-none w-full border-b ${isReadOnly ? 'border-transparent' : 'border-transparent focus:border-white/30 pb-1'}`}
                                       placeholder={isReadOnly ? "" : "Assign name..."}
                                     />
                                     <svg className={`w-4 h-4 text-white/30 ${!isReadOnly ? 'group-hover:text-white transition-colors' : 'hidden'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                       <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                     </svg>
                                  </div>
                               </div>
                            </div>
                          ))}
                       </div>
                    </div>
                  </div>
                  {!isReadOnly && (
                    <div className="mt-20 flex justify-center pb-8">
                        <button onClick={handleSave} className="px-12 py-5 bg-gradient-to-r from-cyan-600 to-blue-700 hover:from-cyan-500 hover:to-blue-600 text-white font-black rounded-full shadow-lg transition-all active:scale-95 flex items-center gap-3">
                        <span>Ø­ÙØ¸ ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ©</span>
                        </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        const RegionModal = ({ manager, onClose, onSave, onOpenArch, theme, isReadOnly }) => {
          const [localData, setLocalData] = useState(null);
          
          useEffect(() => {
            if (manager) setLocalData(JSON.parse(JSON.stringify(manager)));
          }, [manager]);

          if (!manager || !localData) return null;

          const handleStatChange = (field, value) => {
            const numValue = parseInt(value) || 0;
            setLocalData(prev => ({ ...prev, stats: { ...prev.stats, [field]: numValue } }));
          };
          
          const handleTextChange = (field, value) => {
            setLocalData(prev => ({ ...prev, [field]: value }));
          };

          const handleSave = () => {
            if (manager.id) {
              onSave(manager.id, localData);
              onClose();
            }
          };

          const isDark = theme === 'dark';

          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-black/80 backdrop-blur-md" onClick={onClose} />
              <div className={`relative w-full max-w-lg overflow-hidden border rounded-[2.5rem] shadow-2xl p-0 animate-in ${isDark ? 'bg-slate-900/90 text-white border-white/10' : 'bg-white/95 text-slate-900 border-slate-200'}`}>
                <div className="h-2 w-full bg-gradient-to-r from-cyan-500 via-blue-500 to-indigo-500" />
                <div className="p-8 max-h-[90vh] overflow-y-auto">
                  <button onClick={onClose} className={`absolute top-6 left-6 transition-colors ${isDark ? 'text-white/30 hover:text-white' : 'text-slate-400 hover:text-slate-900'}`}>
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                  <header className="text-center mb-6">
                    <div className="flex flex-col items-center gap-2 mb-4">
                        <label className="text-[10px] uppercase opacity-50">Role</label>
                        <input 
                            type="text" 
                            value={localData.role} 
                            readOnly={isReadOnly}
                            onChange={(e) => handleTextChange('role', e.target.value)}
                            className={`text-center text-3xl font-bold bg-transparent border-b ${isReadOnly ? 'border-transparent' : 'border-transparent focus:border-cyan-500'} focus:outline-none w-full bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent`}
                        />
                    </div>
                    <div className="flex flex-col items-center gap-1">
                        <label className="text-[10px] uppercase opacity-50">Name</label>
                         <input 
                            type="text" 
                            value={localData.name} 
                            readOnly={isReadOnly}
                            onChange={(e) => handleTextChange('name', e.target.value)}
                            className={`text-center opacity-60 font-medium text-lg bg-transparent border-b ${isReadOnly ? 'border-transparent' : 'border-transparent focus:border-cyan-500'} focus:outline-none w-full ${isDark ? 'text-white' : 'text-black'}`}
                        />
                    </div>
                  </header>

                  <div className="grid gap-4 mb-10">
                    <div className={`group flex flex-col gap-1 p-5 rounded-3xl border transition-all duration-300 ${isDark ? 'bg-white/5 border-white/10 hover:border-cyan-500/30' : 'bg-slate-50 border-slate-200 hover:border-cyan-500/30'}`}>
                      <span className="text-sm font-bold opacity-60">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯</span>
                      <input type="number" value={localData.stats.total} readOnly={isReadOnly} onChange={(e) => handleStatChange('total', e.target.value)} className={`bg-transparent text-3xl font-black text-cyan-400 focus:outline-none w-full ${isReadOnly ? 'pointer-events-none' : ''}`} />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div className={`p-5 rounded-3xl border ${isDark ? 'bg-white/5 border-white/10' : 'bg-slate-50 border-slate-200'}`}>
                        <span className="text-xs font-bold opacity-50">ØºØ§Ø² Ù…ØµØ±</span>
                        <input type="number" value={localData.stats.egyptGas} readOnly={isReadOnly} onChange={(e) => handleStatChange('egyptGas', e.target.value)} className={`bg-transparent text-xl font-bold focus:outline-none w-full ${isReadOnly ? 'pointer-events-none' : ''}`} />
                      </div>
                      <div className={`p-5 rounded-3xl border ${isDark ? 'bg-white/5 border-white/10' : 'bg-slate-50 border-slate-200'}`}>
                        <span className="text-xs font-bold opacity-50">Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</span>
                        <input type="number" value={localData.stats.institution} readOnly={isReadOnly} onChange={(e) => handleStatChange('institution', e.target.value)} className={`bg-transparent text-xl font-bold focus:outline-none w-full ${isReadOnly ? 'pointer-events-none' : ''}`} />
                      </div>
                    </div>
                    <div className={`p-5 rounded-3xl border ${isDark ? 'bg-white/5 border-white/10' : 'bg-slate-50 border-slate-200'}`}>
                      <span className="text-sm font-bold opacity-70">Ø¹Ø¯Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (PC)</span>
                      <input type="number" value={localData.stats.pcCount} readOnly={isReadOnly} onChange={(e) => handleStatChange('pcCount', e.target.value)} className={`bg-transparent text-3xl font-black text-blue-400 focus:outline-none w-full ${isReadOnly ? 'pointer-events-none' : ''}`} />
                    </div>
                  </div>
                  <div className="flex gap-4">
                    {!isReadOnly && (
                        <button onClick={handleSave} className="flex-[2] py-5 bg-gradient-to-r from-cyan-600 to-blue-700 text-white font-bold rounded-2xl shadow-xl transition-all active:scale-95">Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    )}
                    <button onClick={() => onOpenArch(manager)} className={`flex-[1.2] py-5 rounded-2xl shadow-lg font-bold ${isDark ? 'bg-white/10 text-white' : 'bg-slate-200 text-slate-800'}`}>Ø¹Ø±Ø¶ Ø§Ù„Ù‡ÙŠÙƒÙ„</button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // --- MAIN APP ---

        const App = () => {
          const [theme, setTheme] = useState('dark');
          const [orgData, setOrgData] = useState(INITIAL_ORG_DATA);
          const [selectedManager, setSelectedManager] = useState(null); // For Regions (Stats + Info)
          const [generalEditManager, setGeneralEditManager] = useState(null); // For Non-Region nodes (CEO, etc)
          const [archManager, setArchManager] = useState(null);
          const [user, setUser] = useState(null);
          const [showLogin, setShowLogin] = useState(false);
          const canvasRef = useRef(null);

          // Firebase Sync
          useEffect(() => {
             // Database Listener
             if (window.firebaseDb && window.firebaseRef) {
                 const dataRef = window.firebaseRef(window.firebaseDb, 'orgData');
                 const unsubscribe = window.firebaseOnValue(dataRef, (snapshot) => {
                     const val = snapshot.val();
                     if (val) {
                         setOrgData(val);
                     } else {
                         // Initial Seed if empty
                         window.firebaseSet(dataRef, INITIAL_ORG_DATA);
                     }
                 });
                 return () => unsubscribe();
             }
          }, []);

          useEffect(() => {
              // Auth Listener
              if (window.firebaseAuth && window.firebaseOnAuthStateChanged) {
                  const unsubscribe = window.firebaseOnAuthStateChanged(window.firebaseAuth, (currentUser) => {
                      setUser(currentUser);
                  });
                  return () => unsubscribe();
              }
          }, []);

          // Save to Firebase Helper
          const persistData = (newData) => {
              if (!user) {
                  showToast("âš ï¸ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
                  return;
              }
              setOrgData(newData); // Optimistic UI update
              if (window.firebaseDb && window.firebaseSet && window.firebaseRef) {
                  const dataRef = window.firebaseRef(window.firebaseDb, 'orgData');
                  window.firebaseSet(dataRef, newData).then(() => {
                      showToast("âœ“ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                  }).catch(err => {
                      console.error(err);
                      showToast("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)");
                  });
              } else {
                  showToast("âš ï¸ Firebase not configured");
              }
          };

          const handleLogin = async (email, password) => {
              if (window.firebaseAuth && window.firebaseSignIn) {
                  await window.firebaseSignIn(window.firebaseAuth, email, password);
              }
          };

          const handleLogout = async () => {
              if (window.firebaseAuth && window.firebaseSignOut) {
                  await window.firebaseSignOut(window.firebaseAuth);
              }
          };

          const toggleTheme = () => {
            setTheme(prev => {
              const next = prev === 'dark' ? 'light' : 'dark';
              document.body.classList.toggle('light-mode', next === 'light');
              return next;
            });
          };

          const handleNodeClick = (manager) => {
            if (manager.stats) {
                // If it has stats, it's a Region/SubManager -> Open Region Modal
                setSelectedManager(manager);
            } else {
                // Otherwise it's a generic node -> Open General Edit Modal
                setGeneralEditManager(manager);
            }
          };

          const showToast = (msg) => {
            const existing = document.getElementById('toast');
            if(existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = "fixed top-10 right-1/2 translate-x-1/2 bg-emerald-500 text-white px-6 py-3 rounded-full shadow-xl z-[200] animate-in fade-in slide-in-from-top-4 font-bold";
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
          };

          // Update function for Regions (Stats + Name/Role)
          const handleUpdateRegionData = (id, updatedData) => {
            const newData = { ...orgData };
            // Check SubManagers
            const subIdx = newData.subManagers.findIndex(s => s.id === id);
            if (subIdx !== -1) {
                // It's a SubManager
                newData.subManagers[subIdx] = { ...newData.subManagers[subIdx], ...updatedData };
            } else {
                // It's a nested Region inside a SubManager
                newData.subManagers = newData.subManagers.map(sub => ({
                    ...sub,
                    regions: sub.regions?.map(reg => reg.id === id ? { ...reg, ...updatedData } : reg)
                }));
            }
            persistData(newData);
          };

          // Update function for Architecture
          const handleSaveArch = (id, newArch) => {
            const newData = { ...orgData };
            // Check SubManagers
             const subIdx = newData.subManagers.findIndex(s => s.id === id);
             if (subIdx !== -1) {
                 newData.subManagers[subIdx].architecture = newArch;
             } else {
                 newData.subManagers = newData.subManagers.map(sub => ({
                    ...sub,
                    regions: sub.regions?.map(reg => reg.id === id ? { ...reg, architecture: newArch } : reg)
                 }));
             }
             persistData(newData);
          };

          // Update function for Generic Nodes (CEO, Expert, etc)
          const handleUpdateGeneralNode = (id, updatedFields) => {
              const newData = { ...orgData };
              // Find where this ID lives at the top level
              if (newData.ceo.id === id) newData.ceo = { ...newData.ceo, ...updatedFields };
              else if (newData.expert.id === id) newData.expert = { ...newData.expert, ...updatedFields };
              else if (newData.assistant.id === id) newData.assistant = { ...newData.assistant, ...updatedFields };
              else if (newData.technical.id === id) newData.technical = { ...newData.technical, ...updatedFields };
              else {
                  // Fallback: Check subManagers (though they usually go through RegionModal, this handles edge cases)
                  const subIdx = newData.subManagers.findIndex(s => s.id === id);
                  if (subIdx !== -1) newData.subManagers[subIdx] = { ...newData.subManagers[subIdx], ...updatedFields };
              }
              persistData(newData);
              setGeneralEditManager(null);
          };

          useEffect(() => {
            const canvas = canvasRef.current;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            let animationFrameId;
            const stars = [];
            const numStars = 150;

            const resize = () => {
              canvas.width = window.innerWidth;
              canvas.height = window.innerHeight;
            };

            window.addEventListener('resize', resize);
            resize();

            for (let i = 0; i < numStars; i++) {
              stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                r: Math.random() * 1.5 + 0.5,
                vx: Math.random() * 0.05 - 0.025,
                vy: Math.random() * 0.05 - 0.025,
                op: Math.random() * 0.5 + 0.5
              });
            }

            const draw = () => {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              if (theme === 'dark') {
                ctx.fillStyle = '#FFF';
                stars.forEach(star => {
                  ctx.beginPath();
                  ctx.globalAlpha = star.op;
                  ctx.arc(star.x, star.y, star.r, 0, Math.PI * 2);
                  ctx.fill();
                  star.x += star.vx;
                  star.y += star.vy;
                  if (star.x < 0) star.x = canvas.width;
                  if (star.x > canvas.width) star.x = 0;
                  if (star.y < 0) star.y = canvas.height;
                  if (star.y > canvas.height) star.y = 0;
                });
              }
              animationFrameId = requestAnimationFrame(draw);
            };

            draw();
            return () => {
              window.removeEventListener('resize', resize);
              cancelAnimationFrame(animationFrameId);
            };
          }, [theme]);

          const isDark = theme === 'dark';
          const lineClass = isDark ? 'border-white/20' : 'border-slate-300';
          const bgLineClass = isDark ? 'bg-white/20' : 'bg-slate-300';
          const isReadOnly = !user; // Read only if not logged in

          return (
            <div className={`min-h-screen relative overflow-x-hidden transition-colors duration-500`}>
              <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full -z-10 pointer-events-none" />
              
              {/* Theme Toggle */}
              <div onClick={toggleTheme} className="fixed top-6 left-6 z-50 cursor-pointer bg-white/10 backdrop-blur-md rounded-full p-3 border border-white/20 hover:bg-white/30 transition-all shadow-lg">
                <span className="text-2xl">{isDark ? 'ğŸŒ™' : 'â˜€ï¸'}</span>
              </div>

              {/* Login/Lock Button */}
              <div 
                  onClick={() => user ? handleLogout() : setShowLogin(true)} 
                  className="fixed top-6 right-6 z-50 cursor-pointer bg-white/10 backdrop-blur-md rounded-full p-3 border border-white/20 hover:bg-white/30 transition-all shadow-lg group"
                  title={user ? "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬" : "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø³Ø¤ÙˆÙ„"}
              >
                {user ? (
                   <div className="relative">
                     <span className="text-2xl">ğŸ”“</span>
                     <div className="absolute top-full mt-2 right-0 bg-black/80 text-white text-xs px-2 py-1 rounded hidden group-hover:block whitespace-nowrap">Admin Active</div>
                   </div>
                ) : (
                   <span className="text-2xl grayscale opacity-70 group-hover:grayscale-0 group-hover:opacity-100 transition-all">ğŸ”’</span>
                )}
              </div>

              {/* Modals */}
              {showLogin && <LoginModal onClose={() => setShowLogin(false)} onLogin={handleLogin} theme={theme} />}

              <RegionModal 
                  manager={selectedManager} 
                  onClose={() => setSelectedManager(null)} 
                  onSave={handleUpdateRegionData} 
                  onOpenArch={(m) => { setSelectedManager(null); setArchManager(m); }} 
                  theme={theme}
                  isReadOnly={isReadOnly}
              />
              <ArchitectureModal 
                  manager={archManager} 
                  onClose={() => setArchManager(null)} 
                  onSave={handleSaveArch} 
                  theme={theme} 
                  isReadOnly={isReadOnly}
              />
              <GeneralEditModal 
                  manager={generalEditManager}
                  onClose={() => setGeneralEditManager(null)}
                  onSave={handleUpdateGeneralNode}
                  theme={theme}
                  isReadOnly={isReadOnly}
              />

              <main className="container mx-auto px-4 py-8 relative z-10 flex flex-col items-center">
                <header className="text-center mb-16 w-full">
                  <h1 className="text-4xl md:text-5xl font-bold mb-2 bg-gradient-to-r from-cyan-400 via-blue-300 to-white bg-clip-text text-transparent flicker">
                    Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                  </h1>
                  <div className="inline-block bg-cyan-500/20 backdrop-blur-lg border border-cyan-500/50 px-6 py-1 rounded-full font-bold text-cyan-300 pulse">Ø±Ø¤ÙŠØ© 2026</div>
                </header>

                <div className="w-full max-w-6xl flex flex-col items-center space-y-20">
                  
                  {/* ROOT: CEO */}
                  <div className="flex flex-col items-center relative z-20">
                    <OrgNode manager={orgData.ceo} floating onClick={handleNodeClick} className="ring-4 ring-indigo-500/30" />
                    {/* Main vertical stem down */}
                    <div className={`absolute top-full w-[2px] h-10 ${bgLineClass}`}></div>
                  </div>

                  {/* Level 1: General Managers Split */}
                  <div className="relative w-full z-10">
                    <div className={`absolute top-[-40px] left-[20%] right-[20%] h-[40px] border-x-2 border-t-2 rounded-t-3xl ${lineClass}`}></div>
                    
                    <div className="grid grid-cols-2 gap-4 relative">
                      
                      {/* RIGHT BRANCH (RTL: First Column): Assistant Manager (Purple) */}
                      <div className="flex flex-col items-center relative mr-10 sm:mr-32">
                        <div className="relative flex flex-col items-center">
                            <OrgNode manager={orgData.assistant} onClick={handleNodeClick} className="border-purple-400/50 relative z-20" />
                            
                            {/* TECHNICAL OFFICE: Side Attachment */}
                            <div className="absolute top-1/2 -translate-y-1/2 -right-[150px] md:-right-[200px] flex items-center z-10">
                                 <OrgNode manager={orgData.technical} onClick={handleNodeClick} compact className="scale-90 border-blue-400/50" />
                                 <div className={`w-10 md:w-16 h-[2px] ${bgLineClass}`}></div>
                            </div>

                            <div className={`w-[2px] h-20 bg-gradient-to-b ${isDark ? 'from-purple-400/50' : 'from-purple-600/60'} to-transparent`}></div>
                        </div>
                      </div>

                      {/* LEFT BRANCH (RTL: Second Column): Expert Manager (Cyan) */}
                      <div className="flex flex-col items-center relative">
                        <OrgNode manager={orgData.expert} onClick={handleNodeClick} className="border-cyan-400/50 z-20" />
                        <div className={`w-[2px] h-20 bg-gradient-to-b ${isDark ? 'from-cyan-400/50' : 'from-cyan-600/60'} to-transparent`}></div>
                      </div>

                    </div>
                  </div>

                  {/* SHARED BLOCK: Regions Box */}
                  <div className="relative w-full max-w-5xl z-10">
                    <div className={`absolute top-[-60px] left-[30%] right-[30%] h-[60px] border-x-2 border-t-2 rounded-t-[3rem] ${lineClass}`}></div>
                    
                    <div className={`bg-white/5 backdrop-blur-xl border-2 border-green-500/30 rounded-[3rem] p-8 shadow-2xl overflow-hidden ${!isDark ? 'bg-white/40' : ''}`}>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {orgData.subManagers.map((sub, idx) => (
                          <div key={sub.id} className={`flex flex-col items-center ${idx !== 0 ? `md:border-r ${isDark ? 'border-white/10' : 'border-slate-300'}` : ''}`}>
                            <OrgNode manager={sub} onClick={handleNodeClick} className="w-full max-w-[220px] shadow-none" />
                            <div className="mt-8 flex flex-wrap justify-center gap-3 px-2">
                              {sub.regions?.map(region => (
                                <div key={region.id} className="group relative flex flex-col items-center">
                                   <div className={`text-[9px] mb-1 font-bold uppercase tracking-tighter ${isDark ? 'text-white/40' : 'text-slate-500'}`}>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</div>
                                   <OrgNode manager={region} onClick={handleNodeClick} compact className="scale-95 opacity-80 hover:opacity-100 ring-1 ring-cyan-500/10 shadow-sm" />
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="pt-8 pb-12 flex flex-col items-center w-full">
                    <div className={`text-xl font-bold tracking-widest uppercase mb-6 ${isDark ? 'text-white/20' : 'text-slate-400'}`}>ØªØ·ÙˆÙŠØ± Ù…Ø³ØªÙ…Ø±</div>
                    <div className={`grid grid-cols-4 gap-4 w-full max-w-4xl ${isDark ? 'opacity-10' : 'opacity-20'}`}>
                      {[1,2,3,4].map(i => <div key={i} className="h-16 border border-dashed border-current rounded-2xl"></div>)}
                    </div>
                  </div>
                </div>
              </main>

              <footer className="text-center py-10 border-t border-white/5 opacity-50 relative z-10">
                <div className={`text-xs font-light ${isDark ? 'text-white/40' : 'text-slate-500'}`}>
                  &copy; 2026 Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø© | Ø§Ù„ØªÙ…ÙŠØ² ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                </div>
              </footer>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
